# MyLab.Task.Runtime

`MyLab.Task.Runtime` - среда размещения и запуска задач.

Ознакомьтесь с последними изменениями в [журнале изменений](/CHANGELOG.md).

SDK NuGet: [![NuGet Version and Downloads count](https://buildstats.info/nuget/MyLab.Task.RuntimeSdk)](https://www.nuget.org/packages/MyLab.Task.RuntimeSdk)

## Обзор

`MyLab.Task.Runtime` (далее "`Runtime`") - сервис, обеспечивающий периодическое выполнение задач, реализованных в соответствии с `MyLab.TaskRuntimeSdk` (далее "`SDK`") на платформе `.NET 5.0+`. 

При старте, `Runtime` загружает библиотеки с тасками (далее "ассеты") из директории ассетов. В этих ассетах находятся классы, реализующие интерфейс `ITaskStartup`(из `SDK`). В одном ассете можеет быть несколько таких классов. C помощью объектов этих классов создаются объекты, реализующие интерфейс `ITaskLogic` (из `SDK`), которые должны содержать логику конкретной задачи. При создании объекта задачи применяется персональная конфигурация для каждой задачи.

Созданные объекты логики задач сопоставляются с соответствующей конфигурацией и регистрируются в планировщике с указанным в конфигурации периодом запуска.

Идентификатор задачи, который фигурирует в логах и конфигурации, образуется из имени ассета и имени, назначенного разработчиком. 

![](./doc/main-diagram..png)

## Ассет

### Что такое Ассет?

`Ассет` - библиотека с зависимостями, содержащая набор классов, реализующих соответствующие интерфейсы из `SDK` для реализации логики выполнения задач. Другими словами, с точки зрения разработчика таска - это собранный проект, в котором реализованы классы логики задач и классы инициализации этих объектов логики. 

### ITaskStartup

Задача в ассете определяется классами, реализующими интерфейс `ITaskStartup`, далее "стартап". Требование к классам:

* реализует интерфейс `ITaskStartup`
* публичный
* не абстрактный
* имеет конструктор по умолчанию

Стартап должен реализовать такой же функционал, как класс `Startup` в веб-приложении - инициализацию приложения. Только в данном случае масштаб приложения сужается до таска. 

Ниже приведено объявление интерфейса стартапа.

```c#
/// <summary>
/// Initializes Task application
/// </summary>
public interface ITaskStartup
{
    /// <summary>
    /// Add custom configuration here
    /// </summary>
    void AddConfiguration(IConfigurationBuilder configBuilder);

    /// <summary>
    /// Add task logic and references here
    /// </summary>
    void AddServices(IServiceCollection services, IConfiguration configuration);
}
```

здесь:

* `AddConfiguration` - в этом методе, при необходимости, следует указать дополнительные источники конфигурации
* `AddServices` в этом методе следует добавить класс логики задачи, реализующей `ITaskLogic`, и его зависимости 

Логика задачи может быть зарегистрирована как с временем жизни `Singletone`, так и `Scoped`. `Scoped` - новый экземпляр на каждую итерацию.

!!! Написать про игнор провайдеров логирования. 

### ITaskLogic

Стартап должен добавлять в коллекцию сервисов логику таска. Класс логики таска должен реализовывать интерфейс `ITaskLogic`. Требования к классу логики:

* реализует интерфейс `ITaskLogic`
* не абстрактный

Ниже приведено объявление интерфейса логики таска:

```c#
/// <summary>
/// Provides task logic
/// </summary>
public interface ITaskLogic
{
    /// <summary>
    /// Performs a logic
    /// </summary>
    ValueTask PerformAsync(TaskIterationContext iterationContext, CancellationToken cancellationToken);
}
```

!!! Тут написать про TaskIterationContext

### Идентификатор таска

!!! Тут написать про идентификацию

## Загрузка ассетов

!!! Алгоритм, назначение имён, ограничения (один безымянный стартап, и за одно посмотреть как в коде там на самом деле)

## Конфигурация

!!! Тут написать про конциг и как таски конигурируютс/, как там комбинирование конфигов происходит, сопоставление  по имени. 

## Запуск тасков

!!! Тут написать про параллелизм, про асинхронность, про игнор, если пришло время, а таск всё ещё работает

## Развёртывание

!!! Написать про докер и как добавлять ассеты

 
